// ✅ ManyLangs Firestore Security Rules
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ---- users 컬렉션 ----
    match /users/{uid} {
      // 로그인된 사용자는 자기 문서만 읽고 쓸 수 있음
      allow read, update, delete: if request.auth != null && request.auth.uid == uid;
      allow create: if request.auth != null;

      // 시스템 필드는 직접 수정 금지
      allow update: if request.auth != null
        && request.auth.uid == uid
        && !(('subscription_status' in request.resource.data.diff(resource.data).changedKeys())
          || ('free_pronunciation_used' in request.resource.data.diff(resource.data).changedKeys())
          || ('free_pronunciation_used_at' in request.resource.data.diff(resource.data).changedKeys()));
    }

    // 기타 모든 컬렉션은 기본적으로 읽기·쓰기 금지
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
